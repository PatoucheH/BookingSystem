@using Microsoft.AspNetCore.Identity
@model BookingSystem.Models.ViewModels.PropertyDetailsViewModel
@inject SignInManager<ApplicationUser> SignInManager

@{
    ViewData["Title"] = "Property Details";
    var bookings = Model.Bookings
            .Select(b => new { start = b.StartDate.ToString("yyyy-MM-dd"), end = b.EndDate.ToString("yyyy-MM-dd") });
}

<div class="max-w-4xl mx-auto p-8 mb-20">
    <div class="bg-white rounded-3xl shadow-lg p-6 mb-6">
        <h1 class="text-4xl font-bold text-green-600 text-center">@Model.Property.Title</h1>
    </div>

    <div class="bg-white rounded-3xl shadow-lg overflow-hidden mb-6">
        <img src="@Model.Property.Photo" alt="Property photo" class="w-full h-96 object-cover" />
    </div>

    <div class="bg-white rounded-3xl shadow-lg p-8 mb-6">
        <div class="grid md:grid-cols-1 gap-8">
            <div class="space-y-4 mx-auto max-w-lg">
                <div class="flex items-center p-4 bg-emerald-50 rounded-2xl">
                    <div>
                        <span class="font-bold text-gray-700">Location:</span>
                        <span class="ml-2 text-gray-600">@Model.Property.Town, @Model.Property.Country</span>
                    </div>
                </div>
                <div class="flex items-center p-4 bg-emerald-50 rounded-2xl">
                    <div>
                        <span class="font-bold text-gray-700">Price per night:</span>
                        <span class="ml-2 text-green-600 font-bold text-xl">@Model.Property.Price €</span>
                    </div>
                </div>
                <div class="flex items-center p-4 bg-emerald-50 rounded-2xl">
                    <div>
                        <span class="font-bold text-gray-700">Max Guests:</span>
                        <span class="ml-2 text-gray-600">@Model.Property.GuestNbr</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="mt-8 pt-6 border-t border-gray-200">
            <h2 class="text-2xl font-bold text-green-600 mb-4">Description</h2>
            <p class="text-gray-700 leading-relaxed text-lg">@Model.Property.Description</p>
        </div>
    </div>
    @if (SignInManager.IsSignedIn(User) && (User.IsInRole("Owner") || User.IsInRole("Admin")))
    {
        <div class="flex justify-center items-center my-6">
            <a asp-controller="Property" asp-action="Edit" asp-route-id="@Model.Id"
               class="bg-green-500 text-white font-bold py-4 px-8 rounded-full whitespace-nowrap hover:scale-105 transition duration-200"
               style="min-width: 100px;">
                Edit the property
            </a>
        </div>

    }
    @if (SignInManager.IsSignedIn(User) && (User.IsInRole("Owner") || User.IsInRole("Admin")))
    {
        <div class="flex justify-center items-center my-6">
            <form asp-action="Delete" asp-controller="Property" method="post" onsubmit="return confirm('Are you sure you want to delete this property?');">
                <input type="hidden" name="id" value="@Model.Id" />
                    <button type="submit" class="bg-red-500 text-white font-bold py-4 px-8 rounded-full whitespace-nowrap hover:scale-105 transition duration-200">
                    Delete Property
                </button>
            </form>
        </div>  
    }

    <div class="bg-white rounded-3xl shadow-lg p-8" id="booking-section">
        <h2 class="text-3xl font-bold text-green-600 text-center mb-8">Book Your Stay</h2>

        <form asp-action="Book" method="post" class="space-y-6">
            <input type="hidden" name="PropertyId" value="@Model.Property.Id" />
            <input type="hidden" id="StartDate" name="StartDate" />
            <input type="hidden" id="EndDate" name="EndDate" />

            <div class="bg-emerald-50 rounded-2xl p-6">
                <div class="flex items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-700">Select Your Dates</h3>
                </div>

                <div class="relative">
                    <input type="text"
                           id="date-range"
                           placeholder="Choose your check-in and check-out dates"
                           class="w-full p-4 border-2 border-green-200 rounded-2xl text-lg focus:outline-none focus:border-green-400 focus:ring-2 focus:ring-green-200 transition duration-200 cursor-pointer bg-white"
                           readonly />
                </div>

                <p class="text-sm text-gray-500 mt-2">Unavailable dates are automatically disabled</p>
            </div>

            <div id="booking-summary" class="hidden bg-gradient-to-r from-green-50 to-emerald-50 rounded-2xl p-6 border-2 border-green-200">
                <div class="flex items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-700">Booking Summary</h3>
                </div>

                <div class="grid md:grid-cols-3 gap-4 mb-4">
                    <div class="text-center">
                        <div class="text-sm text-gray-500">Check-in</div>
                        <div id="checkin-date" class="font-bold text-gray-700"></div>
                    </div>
                    <div class="text-center">
                        <div class="text-sm text-gray-500">Check-out</div>
                        <div id="checkout-date" class="font-bold text-gray-700"></div>
                    </div>
                    <div class="text-center">
                        <div class="text-sm text-gray-500">Total nights</div>
                        <div id="total-nights" class="font-bold text-gray-700"></div>
                    </div>
                </div>

                <div class="text-center p-4 bg-white rounded-xl">
                    <div class="text-lg font-bold text-green-600">
                        Total: <span id="total-price">0</span> €
                    </div>
                </div>
            </div>

            <div class="text-center">
                <button type="submit"
                        id="submit-booking"
                        class="bg-green-400 hover:bg-green-500 text-white font-bold py-4 px-12 rounded-3xl shadow-lg transition duration-200 hover:scale-105 text-xl disabled:bg-gray-300 disabled:cursor-not-allowed disabled:hover:scale-100"
                        disabled>
                    Complete Booking
                </button>
            </div>
        </form>
    </div>
</div>

<link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet">

<style>
    .flatpickr-calendar {
        border-radius: 1rem ;
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04) ;
        border: 2px solid #bbf7d0 ;
    }

    .flatpickr-day.selected, .flatpickr-day.selected:hover {
        background: #4ade80 ;
        border-color: #4ade80 ;
    }

    .flatpickr-day.inRange {
        background: #bbf7d0 ;
        color: #065f46 ;
    }

    .flatpickr-day:hover {
        background: #ecfdf5 ;
        color: #065f46 ;
    }

    .flatpickr-months .flatpickr-month {
        background: #4ade80 ;
        color: black ;
    }

    .flatpickr-current-month .flatpickr-monthDropdown-months,
    .flatpickr-current-month input.cur-year {
        background: transparent ;
        color: black ;
    }

    .flatpickr-weekday {
        background: #f0fdf4 ;
        color: #166534 ;
        font-weight: bold ;
    }
</style>

<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<script>
    var unavailableRanges = @Html.Raw(Json.Serialize(bookings));
    var pricePerNight = @Model.Property.Price;

    function scrollToBooking() {
        document.getElementById('booking-section').scrollIntoView({
            behavior: 'smooth'
        });
    }

    function updateBookingSummary(selectedDates) {
        const summaryDiv = document.getElementById('booking-summary');
        const submitBtn = document.getElementById('submit-booking');

        if (selectedDates.length === 2) {
            const startDate = selectedDates[0];
            const endDate = selectedDates[1];
            const nights = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24));
            const totalPrice = nights * pricePerNight;

            document.getElementById('checkin-date').textContent = startDate.toLocaleDateString();
            document.getElementById('checkout-date').textContent = endDate.toLocaleDateString();
            document.getElementById('total-nights').textContent = nights;
            document.getElementById('total-price').textContent = totalPrice;

            summaryDiv.classList.remove('hidden');
            submitBtn.disabled = false;

            summaryDiv.style.opacity = '0';
            summaryDiv.style.transform = 'translateY(20px)';
            setTimeout(() => {
                summaryDiv.style.transition = 'all 0.3s ease';
                summaryDiv.style.opacity = '1';
                summaryDiv.style.transform = 'translateY(0)';
            }, 10);
        } else {
            summaryDiv.classList.add('hidden');
            submitBtn.disabled = true;
        }
    }

    flatpickr("#date-range", {
        mode: "range",
        minDate: "today",
        dateFormat: "Y-m-d",
        disable: unavailableRanges.map(b => ({
            from: b.start,
            to: b.end
        })),
        onChange: function(selectedDates) {
            if (selectedDates.length === 2) {
                document.getElementById("StartDate").value = selectedDates[0].toISOString();
                document.getElementById("EndDate").value = selectedDates[1].toISOString();
            }
            updateBookingSummary(selectedDates);
        }
    });
</script>